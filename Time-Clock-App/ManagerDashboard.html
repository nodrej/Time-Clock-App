<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <!-- date picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    
    <style>
/*DO NOT REMOVE THIS CSS*/
#employee-form-section {
  display: none;  /* Hide employee form by default */
}
/*DO NOT REMOVE THIS CSS*/

/* Modern Dashboard Style */
body {
  font-family: 'Poppins', sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f7fafc;
  color: #2d3748;
  line-height: 1.6;
}

/* Sidebar with gradient */
.sidebar {
  height: 100vh;
  background: linear-gradient(180deg, #4338ca 0%, #3b82f6 100%);
  color: white;
  padding-top: 25px;
  box-shadow: 4px 0 10px rgba(0,0,0,0.1);
  position: relative;
  z-index: 20;
}

.sidebar-item {
  padding: 12px 20px;
  cursor: pointer;
  transition: all 0.3s;
  margin: 5px 10px;
  border-radius: 8px;
  display: flex;
  align-items: center;
}

.sidebar-item i {
  margin-right: 10px;
  font-size: 1.1rem;
  width: 20px;
  text-align: center;
}

.sidebar-item:hover {
  background-color: rgba(255,255,255,0.15);
  transform: translateX(5px);
}

.sidebar-item.active {
  background-color: rgba(255,255,255,0.25);
  transform: translateX(5px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

/* Main content area */
.main-content {
  padding: 30px;
  transition: all 0.3s;
}

/* Page headings */
h2 {
  font-weight: 600;
  margin-bottom: 1.5rem;
  color: #1e293b;
}

/* Card design */
.card {
  border: none;
  border-radius: 16px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  transition: all 0.3s;
  overflow: hidden;
  margin-bottom: 25px;
  background-color: #ffffff;
}

.card:hover {
  box-shadow: 0 8px 25px rgba(0,0,0,0.08);
  transform: translateY(-3px);
}

.card-header {
  background-color: #ffffff;
  border-bottom: 1px solid #e2e8f0;
  padding: 20px;
  font-weight: 600;
  color: #1e293b;
  font-size: 1.1rem;
}

.card-body {
  padding: 20px;
}

.card-title {
  color: #1e293b;
  font-weight: 600;
  margin-bottom: 1rem;
}

/* Tables with modern styling */
.table-container {
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 0 0 1px #e2e8f0;
  max-height: 550px;
  overflow-y: auto;
  background-color: #ffffff;
}

.employee-table, .table {
  margin-bottom: 0;
}

.employee-table th, .table th {
  background-color: #f8fafc;
  color: #1e293b;
  font-weight: 600;
  padding: 16px;
  position: sticky;
  top: 0;
  z-index: 10;
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.5px;
  border-bottom: 2px solid #e2e8f0;
}

.employee-table td, .table td {
  padding: 14px 16px;
  vertical-align: middle;
  border-bottom: 1px solid #e2e8f0;
}

.employee-table tbody tr, .table tbody tr {
  transition: all 0.2s;
}

.employee-table tbody tr:hover, .table tbody tr:hover {
  background-color: #f1f5f9;
  transform: scale(1.01);
}

/* Button styles */
.btn {
  border-radius: 8px;
  font-weight: 500;
  padding: 10px 18px;
  transition: all 0.3s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  display: inline-flex;
  align-items: center;
}

.btn i {
  margin-right: 8px;
}

.btn-primary {
  background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
  border: none;
}

.btn-primary:hover {
  background: linear-gradient(135deg, #4338ca 0%, #2563eb 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25);
}

.btn-secondary {
  background: linear-gradient(135deg, #64748b 0%, #475569 100%);
  border: none;
}

.btn-success {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  border: none;
}

.btn-danger {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  border: none;
}

.btn-warning {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  border: none;
  color: white;
}

.btn-outline-primary {
  color: #4f46e5;
  border-color: #4f46e5;
}

.btn-sm {
  padding: 6px 12px;
  font-size: 0.875rem;
}

/* Form controls */
.form-control, .form-select {
  border-radius: 8px;
  padding: 12px 16px;
  border: 1px solid #cbd5e1;
  transition: all 0.3s;
  background-color: #f8fafc;
  color: #1e293b;
}

.form-control:focus, .form-select:focus {
  border-color: #4f46e5;
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
  background-color: #ffffff;
}

label.form-label {
  font-weight: 500;
  color: #475569;
  margin-bottom: 8px;
}

/* Status styling */
.status-complete {
  color: #10b981;
  font-weight: 600;
}

.status-incomplete {
  color: #ef4444;
  font-weight: 600;
}

/* Badge styling */
.badge {
  padding: 6px 10px;
  font-weight: 500;
  border-radius: 6px;
}

.bg-success {
  background-color: #10b981 !important;
}

.bg-danger {
  background-color: #ef4444 !important;
}

.bg-warning {
  background-color: #f59e0b !important;
  color: #ffffff !important;
}

/* Loading overlay with blur */
.loading-overlay {
  background-color: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(5px);
  z-index: 2000;
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border: 5px solid rgba(79, 70, 229, 0.1);
  border-top: 5px solid #4f46e5;
  border-radius: 50%;
  animation: spin 1s cubic-bezier(0.45, 0, 0.55, 1) infinite;
}

/* Filter section styling */
.filter-section {
  background-color: #f1f5f9;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 25px;
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
}

.filter-item {
  flex: 1;
  min-width: 200px;
}

/* Flagged log styling */
.flagged-log {
  background-color: rgba(239, 68, 68, 0.05);
  border-left: 4px solid #ef4444;
}

tr:hover .flagged-log {
  background-color: rgba(239, 68, 68, 0.1);
}

/* Alert styling */
.alert {
  border-radius: 12px;
  padding: 12px 18px;
  margin-bottom: 20px;
  border: none;
}

.alert-success {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
  border-left: 4px solid #10b981;
}

.alert-danger {
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
  border-left: 4px solid #ef4444;
}

.alert-warning {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.1) 100%);
  border-left: 4px solid #f59e0b;
}

/* Modal styling */
.modal-content {
  border: none;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 25px 50px rgba(0,0,0,0.1);
}

.modal-header {
  background-color: #f8fafc;
  border-bottom: 1px solid #e2e8f0;
  padding: 20px;
}

.modal-title {
  font-weight: 600;
  color: #1e293b;
}

.modal-body {
  padding: 20px;
}

.modal-footer {
  padding: 15px 20px;
  border-top: 1px solid #e2e8f0;
}

/* Grant eligible hours button */
#grant-eligible-hours {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  border: none;
  padding: 12px 20px;
  font-size: 1rem;
  font-weight: 600;
  letter-spacing: 0.5px;
  box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
}

#grant-eligible-hours:hover {
  background: linear-gradient(135deg, #059669 0%, #047857 100%);
  transform: translateY(-3px);
  box-shadow: 0 8px 15px rgba(5, 150, 105, 0.3);
}

/* Animation for hoverable elements */
.card, .btn, .sidebar-item {
  will-change: transform;
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 sidebar">
          <div class="sidebar-item active" data-tab="employees">
            <i class="fas fa-users me-2"></i> Employees
          </div>
          <div class="sidebar-item" data-tab="time-tracking">
            <i class="fas fa-clock me-2"></i> Time Tracking
          </div>
          <div class="sidebar-item" data-tab="operator-attendance">
            <i class="fas fa-user-clock me-2"></i> Operator Attendance
          </div>
          <div class="sidebar-item" data-tab="reports">
            <i class="fas fa-chart-bar me-2"></i> Reports
          </div>
          <div class="sidebar-item" data-tab="settings">
            <i class="fas fa-cog me-2"></i> Settings
          </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-10 main-content">
          <div id="alerts-container" class="container mt-3"></div>
          <!-- Employees Tab -->
          <div id="employees-tab" class="tab-content active">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2>Employee Management</h2>
              <button id="add-employee-btn" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Add Employee
              </button>
            </div>
            
            <!-- Search and Filter -->
            <div class="card mb-4">
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-4">
                    <input type="text" id="search-employee" class="form-control" placeholder="Search employees...">
                  </div>
                  <div class="col-md-3">
                    <select id="status-filter" class="form-select">
                      <option value="all">All Statuses</option>
                      <option value="Active" selected>Active</option>
                      <option value="Inactive">Inactive</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <select id="department-filter" class="form-select">
                      <option value="all">All Departments</option>
                      <!-- Will be populated dynamically -->
                    </select>
                  </div>
                  <div class="col-md-2">
                    <button id="reset-filters" class="btn btn-secondary w-100">Reset</button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Employee Table -->
            <div class="card">
              <div class="card-body">
                <div class="table-container">
                  <table class="employee-table" id="employee-table">
                    <thead>
                      <tr>
                        <th data-sort="id">ID <i class="fas fa-sort"></i></th>
                        <th data-sort="firstName">First Name <i class="fas fa-sort"></i></th>
                        <th data-sort="lastName">Last Name <i class="fas fa-sort"></i></th>
                        <th data-sort="department">Department <i class="fas fa-sort"></i></th>
                        <th data-sort="email">Email <i class="fas fa-sort"></i></th>
                        <th data-sort="shift">Shift <i class="fas fa-sort"></i></th>
                        <th data-sort="status">Status <i class="fas fa-sort"></i></th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="employee-table-body">
                      <!-- Employee data will be populated here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Add/Edit Employee Form -->
          <div id="employee-form-section" class="form-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2 id="form-title">Add New Employee</h2>
              <button id="back-to-list" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to List
              </button>
            </div>
            
            <div class="card">
              <div class="card-body">
                <form id="employee-form">
                  <input type="hidden" id="employee-id">
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="first-name" class="form-label">First Name *</label>
                      <input type="text" class="form-control" id="first-name" required>
                    </div>
                    <div class="col-md-6">
                      <label for="last-name" class="form-label">Last Name *</label>
                      <input type="text" class="form-control" id="last-name" required>
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="department" class="form-label">Department</label>
                      <input type="text" class="form-control" id="department">
                    </div>
                    <div class="col-md-6">
                      <label for="email" class="form-label">Email</label>
                      <input type="email" class="form-control" id="email">
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="pin" class="form-label">PIN *</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="pin" required>
                        <button type="button" class="btn btn-outline-secondary" id="generate-pin">Generate</button>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label for="manager-email" class="form-label">Manager Email</label>
                      <input type="email" class="form-control" id="manager-email">
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="hire-date" class="form-label">Hire Date *</label>
                      <input type="date" class="form-control" id="hire-date" required>
                    </div>
                    <div class="col-md-6">
                      <label for="status" class="form-label">Status *</label>
                      <select class="form-select" id="status" required>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="shift" class="form-label">Shift</label>
                      <select class="form-select" id="shift">
                        <option value="">No Shift Assigned</option>
                        <!-- Shift options will be populated dynamically -->
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="shift-id" class="form-label">Shift ID</label>
                      <input type="text" class="form-control" id="shift-id" readonly>
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="company" class="form-label">Company</label>
                      <select class="form-select" id="company">
                        <option value="">Not Set</option>
                        <option value="Humboldt">Humboldt</option>
                        <option value="Trigger2a">Trigger2a</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="employment-type" class="form-label">Employment Type</label>
                      <select class="form-select" id="employment-type">
                        <option value="">Not Set</option>
                        <option value="W-4">W-4</option>
                        <option value="Independent Contractor">Independent Contractor</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="schedule-type" class="form-label">Schedule Type</label>
                      <select class="form-select" id="schedule-type">
                        <option value="">Not Set</option>
                        <option value="Full Time">Full Time</option>
                        <option value="Part Time">Part Time</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="payment-type" class="form-label">Payment Type</label>
                      <select class="form-select" id="payment-type">
                        <option value="">Not Set</option>
                        <option value="Hourly">Hourly</option>
                        <option value="Salary">Salary</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="hourly-rate" class="form-label">Hourly Rate</label>
                      <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="hourly-rate" step="0.01" min="0">
                      </div>
                    </div>
                  </div>
                  
                  <div class="d-flex justify-content-end mt-4">
                    <button type="button" class="btn btn-secondary me-2" id="cancel-form">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Employee</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          
          <!-- Time Tracking Tab -->
          <div id="time-tracking-tab" class="tab-content" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2>Time Logs Management</h2>
              <button id="createTimeLogBtn" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Create Time Log
              </button>
            </div>
            
            <!-- Filter Section -->
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Filters</h5>
                <div class="filter-section">
                  <div class="filter-item">
                    <label for="dateFilter" class="form-label">Date</label>
                    <input type="text" id="dateFilter" class="form-control flatpickr-date" placeholder="Select date">
                  </div>
                  <div class="filter-item">
                    <label for="employeeFilter" class="form-label">Employee</label>
                    <select id="employeeFilter" class="form-select">
                      <option value="">All Employees</option>
                      <!-- Will be populated dynamically -->
                    </select>
                  </div>
                  <div class="form-check ms-3">
                    <input class="form-check-input" type="checkbox" id="missedMinutesFilter">
                    <label class="form-check-label" for="missedMinutesFilter">
                      Has Missed Minutes
                    </label>
                  </div>
                  <div class="filter-item d-flex align-items-end">
                    <button id="applyFilters" class="btn btn-primary">Apply Filters</button>
                    <button id="clearFilters" class="btn btn-outline-secondary ms-2">Clear</button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Time Logs Table -->
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Time Logs</h5>
                <div class="table-container">
                  <table class="time-logs-table table table-hover">
                    <thead>
                      <tr>
                        <th>Log ID</th>
                        <th>Employee</th>
                        <th>Date</th>
                        <th>Clock In</th>
                        <th>Clock Out</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="timeLogsTableBody">
                      <!-- Will be populated dynamically -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          
        

<!-- Edit Time Log Modal with Clear Buttons - Updated Layout -->
<div class="modal fade" id="editTimeLogModal" tabindex="-1" aria-labelledby="editTimeLogModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editTimeLogModalLabel">Edit Time Log</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editTimeLogForm">
          <!-- Hidden fields -->
          <input type="hidden" id="rowIndex">
          <input type="hidden" id="logId">
          <input type="hidden" id="employeeId">
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="employeeName" class="form-label">Employee</label>
              <input type="text" class="form-control" id="employeeName" readonly>
            </div>
            <div class="col-md-6">
              <label for="status" class="form-label">Status</label>
              <input type="text" class="form-control" id="status" readonly>
            </div>
          </div>
          
          <div class="row mb-3">
            <!-- Clock In Date and Time - Vertical Layout -->
            <div class="col-md-6">
              <label class="form-label">Clock In</label>
              <div class="input-group mb-2">
                <span class="input-group-text" style="width: 80px;">Date</span>
                <input type="date" class="form-control" id="clockInDate" autocomplete="off">
                <button type="button" class="btn btn-outline-secondary clear-field" data-target="clockInDate">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="input-group">
                <span class="input-group-text" style="width: 80px;">Time</span>
                <input type="time" class="form-control" id="clockInTime" autocomplete="off">
                <button type="button" class="btn btn-outline-secondary clear-field" data-target="clockInTime">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            
            <!-- Clock Out Date and Time - Vertical Layout -->
            <div class="col-md-6">
              <label class="form-label">Clock Out</label>
              <div class="input-group mb-2">
                <span class="input-group-text" style="width: 80px;">Date</span>
                <input type="date" class="form-control" id="clockOutDate" autocomplete="off">
                <button type="button" class="btn btn-outline-secondary clear-field" data-target="clockOutDate">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="input-group">
                <span class="input-group-text" style="width: 80px;">Time</span>
                <input type="time" class="form-control" id="clockOutTime" autocomplete="off">
                <button type="button" class="btn btn-outline-secondary clear-field" data-target="clockOutTime">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Regular Break 1</label>
              <div class="input-group mb-2">
                <span class="input-group-text" style="width: 80px;">Start</span>
                <input type="time" class="form-control" id="regularBreakStart1" autocomplete="off">
                <button type="button" class="btn btn-outline-secondary clear-field" data-target="regularBreakStart1">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="input-group">
                <span class="input-group-text" style="width: 80px;">End</span>
                <input type="time" class="form-control" id="regularBreakEnd1" autocomplete="off">
                <button type="button" class="btn btn-outline-secondary clear-field" data-target="regularBreakEnd1">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Regular Break 2</label>
              <div class="input-group mb-2">
                <span class="input-group-text" style="width: 80px;">Start</span>
                <input type="time" class="form-control" id="regularBreakStart2" autocomplete="off">
                <button type="button" class="btn btn-outline-secondary clear-field" data-target="regularBreakStart2">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="input-group">
                <span class="input-group-text" style="width: 80px;">End</span>
                <input type="time" class="form-control" id="regularBreakEnd2" autocomplete="off">
                <button type="button" class="btn btn-outline-secondary clear-field" data-target="regularBreakEnd2">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Lunch Break</label>
              <div class="input-group mb-2">
                <span class="input-group-text" style="width: 80px;">Start</span>
                <input type="time" class="form-control" id="lunchBreakStart" autocomplete="off">
                <button type="button" class="btn btn-outline-secondary clear-field" data-target="lunchBreakStart">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="input-group">
                <span class="input-group-text" style="width: 80px;">End</span>
                <input type="time" class="form-control" id="lunchBreakEnd" autocomplete="off">
                <button type="button" class="btn btn-outline-secondary clear-field" data-target="lunchBreakEnd">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveTimeLog">Save Changes</button>
      </div>
    </div>
  </div>
</div>




          <div id="operator-attendance-tab" class="tab-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2>Operator Attendance Analysis</h2>
            </div>
            
            <div class="card mb-4">
              <div class="card-body">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="attendance-pay-period" class="form-label">Select Pay Period</label>
                    <select class="form-select" id="attendance-pay-period">
                      <option value="">Loading pay periods...</option>
                    </select>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-md-12 text-end">
                    <button id="analyze-attendance" class="btn btn-primary">
                      <i class="fas fa-search me-2"></i>Analyze Attendance
                    </button>
                  </div>
                </div>
              </div>
            </div>
             <!-- Analysis Results -->
  <div class="card">
    <div class="card-body">
      <div id="attendance-loading" style="display: none;" class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Analyzing attendance data...</p>
      </div>
      
      <div id="attendance-results-container" style="display: none;">
        <h5 class="card-title mb-3">Analysis Results</h5>
        <div class="table-container">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Employee ID</th>
                <th>Name</th>
                <th>Shift</th>
                <th>Total Hours</th>
                <th>Shifts Worked</th>
                <th>Missed Minutes</th>
                <th>Eligible for Benefits</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody id="attendance-results">
              <!-- Results will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
      
      <div id="no-results-message" style="display: none;" class="alert alert-info">
        No results found. Please select a pay period and try again.
      </div>
    </div>
  </div>
  
<!-- Attendance Details Modal -->
<div class="modal fade" id="attendanceDetailsModal" tabindex="-1" aria-labelledby="attendanceDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="attendanceDetailsModalLabel">Attendance Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <h4 id="details-employee-name">Employee Name</h4>
            <p id="details-employee-shift">Shift: Morning</p>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Attendance Summary</h5>
                <div class="row">
                  <div class="col-md-6">
                    <p><strong>Total Hours:</strong> <span id="details-total-hours">0</span></p>
                    <p><strong>Shifts Worked:</strong> <span id="details-shifts-worked">0</span></p>
                  </div>
                  <div class="col-md-6">
                    <p><strong>Missed Minutes:</strong> <span id="details-missed-minutes">0</span></p>
                    <p><strong>Eligible for Bonus:</strong> <span id="details-eligibility">No</span></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body text-center">
                <h5 class="card-title">Late Minutes</h5>
                <h3 id="details-late-minutes">0</h3>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-body text-center">
                <h5 class="card-title">Early Departure</h5>
                <h3 id="details-early-minutes">0</h3>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-body text-center">
                <h5 class="card-title">Break Violations</h5>
                <h3 id="details-break-minutes">0</h3>
              </div>
            </div>
          </div>
        </div>
        
        <h5 class="mb-3">Total Missed Minutes For Each Attendance Log</h5>
        <div class="table-responsive">
          <table class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>Date</th>
                <th>Regular Break 1</th>
                <th>Regular Break 2</th>
                <th>Lunch Break</th>
                <th>Late Arrival</th>
                <th>Early Departure</th>
                <th>Total</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="details-attendance-log">
              <!-- Logs will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



</div>



         
<!-- Reports Tab -->
<div id="reports-tab" class="tab-content">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Time Tracking Reports</h2>
  </div>
  
  <div class="card mb-4">
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Report Type</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="reportType" id="customDateRange" value="custom" >
            <label class="form-check-label" for="customDateRange">
              Custom Date Range
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="reportType" id="payPeriodRange" value="payPeriod" checked>
            <label class="form-check-label" for="payPeriodRange">
              Pay Period
            </label>
          </div>
        </div>
      </div>
      
      <!-- Custom Date Range Section -->
      <div id="customDateRangeSection" class="row mb-3">
        <div class="col-md-3">
          <label for="startDate" class="form-label">Start Date</label>
          <input type="date" class="form-control" id="startDate">
        </div>
        <div class="col-md-3">
          <label for="startTime" class="form-label">Start Time</label>
          <input type="time" class="form-control" id="startTime" value="00:00">
        </div>
        <div class="col-md-3">
          <label for="endDate" class="form-label">End Date</label>
          <input type="date" class="form-control" id="endDate">
        </div>
        <div class="col-md-3">
          <label for="endTime" class="form-label">End Time</label>
          <input type="time" class="form-control" id="endTime" value="23:59">
        </div>
      </div>
      
      <!-- Pay Period Section -->
      <div id="payPeriodSection" class="row mb-3">
        <div class="col-md-6">
          <label for="payPeriod" class="form-label">Select Pay Period</label>
          <select class="form-select" id="payPeriod">
            <option value="">Loading pay periods...</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="profitSharingAmount" class="form-label">Total Profit Sharing Amount</label>
          <div class="input-group">
            <span class="input-group-text">$</span>
            <input type="number" class="form-control" id="profitSharingAmount" min="0" step="0.01" placeholder="Enter amount to distribute">
          </div>
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-12 text-end">
          <button id="generateReport" class="btn btn-primary">
            <i class="fas fa-chart-bar me-2"></i>Generate Report
          </button>
        </div>
      </div>
      <div class="d-flex justify-content-end mt-3">
        <button id="exportCsv" class="btn btn-outline-success me-2" disabled>
          <i class="fas fa-file-csv me-1"></i> Export CSV
        </button>
        <button id="exportPdf" class="btn btn-outline-danger" disabled>
          <i class="fas fa-file-pdf me-1"></i> Export PDF
        </button>
      </div>
    </div>
  </div>
  
  <!-- Report Results -->
  <div class="card">
    <div class="card-body">
      <div id="reportLoading" style="display: none;" class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Generating report...</p>
      </div>
      
      <div id="reportResults">
        <div class="table-container">
          <table class="table table-striped table-hover table-responsive">
            <thead>
              <tr>
                <th style="width: 20%;">Employee Name</th>
                <th style="width: 15%;">Employment Type</th>
                <th style="width: 10%;">Hourly Rate</th>
                <th style="width: 12%;">Regular Hours</th>
                <th style="width: 12%;">Overtime Hours</th>
                <th style="width: 15%;">Paid Break Hours</th>
                <th style="width: 16%;">Profit Sharing $</th>
              </tr>
            </thead>
            <tbody id="reportTableBody">
              <!-- Report data will be populated here -->
            </tbody>
          </table>
        </div>
      </div>


    </div>
  </div>
</div>




        </div>
      </div>
    </div>

<!-- Create New Time Log Modal -->
<div class="modal fade" id="createTimeLogModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create New Time Log</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="createTimeLogForm">
          <div class="row mb-3">
            <div class="col-md-12">
              <label for="newLogEmployeeId" class="form-label">Employee *</label>
              <select id="newLogEmployeeId" class="form-select" required>
                <option value="">Select Employee</option>
                <!-- Will be populated dynamically -->
              </select>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="newLogClockInDate" class="form-label">Clock In Date *</label>
              <input type="date" id="newLogClockInDate" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label for="newLogClockInTime" class="form-label">Clock In Time *</label>
              <input type="time" id="newLogClockInTime" class="form-control" required>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="newLogClockOutDate" class="form-label">Clock Out Date</label>
              <input type="date" id="newLogClockOutDate" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="newLogClockOutTime" class="form-label">Clock Out Time</label>
              <input type="time" id="newLogClockOutTime" class="form-control">
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-12">
              <label for="newLogNotes" class="form-label">Notes</label>
              <textarea id="newLogNotes" class="form-control" rows="2"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveNewTimeLog">Create Time Log</button>
      </div>
    </div>
  </div>
</div>


    
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
      <div class="loading-spinner"></div>
    </div>
    
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Flatpickr for date/time picker -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- html2pdf.js for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
      // Global variables
      let employees = [];
      let shifts = [];
      let departments = [];
      let sortField = 'id';
      let sortDirection = 'asc';
      let editTimeLogModal;
      let createTimeLogModal;
      
      // Show loading spinner
      function showLoading() {
        document.getElementById('loading-overlay').style.display = 'flex';
      }
      
      // Hide loading spinner
      function hideLoading() {
        document.getElementById('loading-overlay').style.display = 'none';
      }
      
      // Initialize the dashboard
      function initializeDashboard() {
        // Initialize time tracking modal
        editTimeLogModal = new bootstrap.Modal(document.getElementById('editTimeLogModal'));
        
        // Initialize date/time pickers
        initializeDateTimePickers();

        // Initialize time tracking modal
  editTimeLogModal = new bootstrap.Modal(document.getElementById('editTimeLogModal'));
  createTimeLogModal = new bootstrap.Modal(document.getElementById('createTimeLogModal'));
        
        // Tab switching
        document.querySelectorAll('.sidebar-item').forEach(item => {
          item.addEventListener('click', function() {
            // Remove active class from all sidebar items
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            // Add active class to clicked item
            this.classList.add('active');
            
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(tab => {
              tab.style.display = 'none';
            });
            
            // Show the selected tab content
            const tabId = this.getAttribute('data-tab') + '-tab';
            document.getElementById(tabId).style.display = 'block';
            
            // If time tracking tab is selected, load its data
            if (tabId === 'time-tracking-tab') {
              loadEmployeesForTimeTracking();
              loadTimeLogs();
} else if (tabId === 'operator-attendance-tab') {
      initOperatorAttendanceTab();  // Add this line to fix the issue
      

            }
          });
        });
        
        // Initially hide all tabs except employees
        document.querySelectorAll('.tab-content').forEach(tab => {
          if (tab.id !== 'employees-tab') {
            tab.style.display = 'none';
          }
        });
        
        // Add Employee button
        document.getElementById('add-employee-btn').addEventListener('click', showAddEmployeeForm);
        
        // Back to list button
        document.getElementById('back-to-list').addEventListener('click', hideEmployeeForm);
        
        // Cancel form button
        document.getElementById('cancel-form').addEventListener('click', hideEmployeeForm);
        
        // Generate PIN button
        document.getElementById('generate-pin').addEventListener('click', generateRandomPin);
        
        // Form submission
        document.getElementById('employee-form').addEventListener('submit', handleEmployeeFormSubmit);
        
        // Search functionality
        document.getElementById('search-employee').addEventListener('input', filterEmployees);
        
        // Status filter
        document.getElementById('status-filter').addEventListener('change', filterEmployees);
        
        // Department filter
        document.getElementById('department-filter').addEventListener('change', filterEmployees);
        
        // Reset filters
        document.getElementById('reset-filters').addEventListener('click', resetFilters);

        // Add event listener for Create Time Log button
  document.getElementById('createTimeLogBtn').addEventListener('click', showCreateTimeLogModal);
  document.getElementById('saveNewTimeLog').addEventListener('click', saveNewTimeLog);
  
        
        // Table sorting
        document.querySelectorAll('th[data-sort]').forEach(th => {
          th.addEventListener('click', function() {
            const field = this.getAttribute('data-sort');
            if (sortField === field) {
              sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
              sortField = field;
              sortDirection = 'asc';
            }
            renderEmployeeTable();
          });
        });
        
        // Shift selection change
        document.getElementById('shift').addEventListener('change', function() {
          const selectedShift = this.value;
          const shiftIdField = document.getElementById('shift-id');
          
          if (selectedShift) {
            const selectedShiftData = shifts.find(shift => shift.name === selectedShift);
            shiftIdField.value = selectedShiftData ? selectedShiftData.id : '';
          } else {
            shiftIdField.value = '';
          }
        });
        
        // Time tracking event listeners
        document.getElementById('applyFilters').addEventListener('click', loadTimeLogs);
        document.getElementById('clearFilters').addEventListener('click', function() {
          document.getElementById('dateFilter').value = '';
          document.getElementById('employeeFilter').value = '';
          document.getElementById('missedMinutesFilter').checked = false;
          loadTimeLogs();
        });
        
        document.getElementById('saveTimeLog').addEventListener('click', saveTimeLog);
        
        // Load initial data
        loadEmployees();
        loadShifts();
  
  // Load initial data
  loadEmployees();
  loadShifts();
  loadPayPeriods(); // Add this line to load pay periods

          // Initialize reports tab
          initReportsTab();
}

// Initialize clear buttons for time log form fields
function initializeClearButtons() {
  document.querySelectorAll('.clear-field').forEach(button => {
    button.addEventListener('click', function() {
      const targetId = this.getAttribute('data-target');
      const targetField = document.getElementById(targetId);
      
      if (targetField) {
        targetField.value = '';
        
        // If this is a flatpickr field, we need to update the flatpickr instance
        if (targetField._flatpickr) {
          targetField._flatpickr.clear();
        }
      }
    });
  });
}

// Initialize date/time pickers
function initializeDateTimePickers() {
  // Initialize date pickers
  flatpickr(".flatpickr-date", {
    dateFormat: "Y-m-d",
    allowInput: true
  });
  
  // Initialize time pickers with the same configuration as Reports tab
  flatpickr(".flatpickr-time", {
    enableTime: true,
    noCalendar: true,
    dateFormat: "H:i:s",
    time_24hr: true,
    minuteIncrement: 1,
    allowInput: true
  });
}
      
      // Show Add Employee Form
      function showAddEmployeeForm() {
        // Hide employee list
        document.getElementById('employees-tab').style.display = 'none';
        
        // Show form
        const formSection = document.getElementById('employee-form-section');
        formSection.style.display = 'block';
        
        // Set form title
        document.getElementById('form-title').textContent = 'Add New Employee';
        
        // Clear form fields
        document.getElementById('employee-form').reset();
        document.getElementById('employee-id').value = '';
        
        // Set today's date as default hire date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('hire-date').value = today;
      }
      
      // Show Edit Employee Form
function showEditEmployeeForm(employeeId) {
  
  
  
  // Find employee data
  const employee = employees.find(emp => emp.id == employeeId);
  if (!employee) return;
  
  // Hide employee list
  document.getElementById('employees-tab').style.display = 'none';
  
  // Show form
  const formSection = document.getElementById('employee-form-section');
  formSection.style.display = 'block';
  
  // Set form title
  document.getElementById('form-title').textContent = 'Edit Employee';
  
  // Populate form fields
  document.getElementById('employee-id').value = employee.id;
  document.getElementById('first-name').value = employee.firstName || '';
  document.getElementById('last-name').value = employee.lastName || '';
  document.getElementById('department').value = employee.department || '';
  document.getElementById('email').value = employee.email || '';
  document.getElementById('pin').value = employee.pin || '';
  document.getElementById('manager-email').value = employee.managerEmail || '';
  document.getElementById('hire-date').value = formatDateForInput(employee.hireDate) || '';
  document.getElementById('status').value = employee.status || 'Active';
  document.getElementById('shift').value = employee.shift || '';
  document.getElementById('shift-id').value = employee.shiftId || '';
  
  // Populate new fields
  document.getElementById('company').value = employee.company || '';
  document.getElementById('employment-type').value = employee.employmentType || '';
  document.getElementById('schedule-type').value = employee.scheduleType || '';
  document.getElementById('payment-type').value = employee.paymentType || '';
  document.getElementById('hourly-rate').value = employee.hourlyRate || '';
}
      
      // Hide Employee Form
      function hideEmployeeForm() {
        // Show employee list
        document.getElementById('employees-tab').style.display = 'block';
        
        // Hide form
        document.getElementById('employee-form-section').style.display = 'none';
      }
      
      // Generate Random PIN
      function generateRandomPin() {
        const pin = Math.floor(1000 + Math.random() * 9000); // 4-digit PIN
        document.getElementById('pin').value = pin;
      }
      
      // Format date for input field (YYYY-MM-DD)
      function formatDateForInput(dateStr) {
        if (!dateStr) return '';
        
        try {
          const date = new Date(dateStr);
          return date.toISOString().split('T')[0];
        } catch (e) {
          return '';
        }
      }
      
      // Handle form submission
function handleEmployeeFormSubmit(e) {
  e.preventDefault();
  
  // Show loading spinner
  showLoading();
  
  // Get form data
  const employeeId = document.getElementById('employee-id').value;
  const firstName = document.getElementById('first-name').value;
  const lastName = document.getElementById('last-name').value;
  const department = document.getElementById('department').value;
  const email = document.getElementById('email').value;
  const pin = document.getElementById('pin').value;
  const managerEmail = document.getElementById('manager-email').value;
  const hireDate = document.getElementById('hire-date').value;
  const status = document.getElementById('status').value;
  const shift = document.getElementById('shift').value;
  const shiftId = document.getElementById('shift-id').value;
  
  // Get new field values
  const company = document.getElementById('company').value;
  const employmentType = document.getElementById('employment-type').value;
  const scheduleType = document.getElementById('schedule-type').value;
  const paymentType = document.getElementById('payment-type').value;
  const hourlyRate = document.getElementById('hourly-rate').value;
  
  // Prepare employee data
  const employeeData = {
    id: employeeId || 'NEW', // 'NEW' indicates a new employee
    firstName,
    lastName,
    department,
    email,
    pin,
    managerEmail,
    hireDate,
    status,
    shift,
    shiftId,
    // Add new fields
    company,
    employmentType,
    scheduleType,
    paymentType,
    hourlyRate
  };
  
  // Call Google Apps Script function to save employee
  google.script.run
    .withSuccessHandler(onEmployeeSaved)
    .withFailureHandler(onSaveError)
    .saveEmployee(employeeData);
}
      
      // Handle successful save
      function onEmployeeSaved(result) {
        hideLoading();
        
        if (result.success) {
          // Reload employees and show the list
          loadEmployees();
          hideEmployeeForm();
          
          // Show success message
          showAlert('success', 'Employee saved successfully!');
        } else {
          // Show error message
          showAlert('danger', 'Error: ' + result.message);
        }
      }
      
      // Handle save error
      function onSaveError(error) {
        hideLoading();
        showAlert('danger', 'Error saving employee: ' + error.message);
      }
      
      // Load employees from server
      function loadEmployees() {
        showLoading();
        
        google.script.run
          .withSuccessHandler(onEmployeesLoaded)
          .withFailureHandler(onLoadError)
          .getEmployees();
      }
      
      // Handle loaded employees
      function onEmployeesLoaded(data) {
        hideLoading();
        employees = data;
        
        // Extract unique departments for filter
        const deptSet = new Set();
        employees.forEach(emp => {
          if (emp.department) deptSet.add(emp.department);
        });
        departments = Array.from(deptSet).sort();
        
        // Populate department filter
        const deptFilter = document.getElementById('department-filter');
        deptFilter.innerHTML = '<option value="all">All Departments</option>';
        departments.forEach(dept => {
          const option = document.createElement('option');
          option.value = dept;
          option.textContent = dept;
          deptFilter.appendChild(option);
        });
        
        // Render employee table
        renderEmployeeTable();
      }
      
      // Load shifts from server
      function loadShifts() {
        google.script.run
          .withSuccessHandler(onShiftsLoaded)
          .withFailureHandler(onLoadError)
          .getShifts();
      }
      
      // Handle loaded shifts
      function onShiftsLoaded(data) {
        shifts = data;
        
        // Populate shift dropdown
        const shiftSelect = document.getElementById('shift');
        shiftSelect.innerHTML = '<option value="">No Shift Assigned</option>';
        
        shifts.forEach(shift => {
          const option = document.createElement('option');
          option.value = shift.name;
          option.textContent = shift.name;
          shiftSelect.appendChild(option);
        });
      }
      
      // Handle load error
      function onLoadError(error) {
        hideLoading();
        showAlert('danger', 'Error loading data: ' + error.message);
      }
      
      // Render employee table
      function renderEmployeeTable() {
        const tableBody = document.getElementById('employee-table-body');
        tableBody.innerHTML = '';
        
        // Apply filters and sorting
        let filteredEmployees = filterEmployeesList();
        
        // Sort employees
        filteredEmployees.sort((a, b) => {
          let aValue = a[sortField] || '';
          let bValue = b[sortField] || '';
          
          // Convert to numbers for ID field
          if (sortField === 'id') {
            aValue = parseInt(aValue) || 0;
            bValue = parseInt(bValue) || 0;
          }
          
          if (aValue < bValue) {
            return sortDirection === 'asc' ? -1 : 1;
          }
          if (aValue > bValue) {
            return sortDirection === 'asc' ? 1 : -1;
          }
          return 0;
        });
        
        // Create table rows
        filteredEmployees.forEach(employee => {
          const row = document.createElement('tr');
          
          row.innerHTML = `
            <td>${employee.id}</td>
            <td>${employee.firstName || ''}</td>
            <td>${employee.lastName || ''}</td>
            <td>${employee.department || ''}</td>
            <td>${employee.email || ''}</td>
            <td>${employee.shift || ''}</td>
            <td>
              <span class="badge ${employee.status === 'Active' ? 'bg-success' : 'bg-secondary'}">
                ${employee.status || ''}
              </span>
            </td>
            <td class="action-buttons">
              <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${employee.id}">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-outline-warning reset-pin-btn" data-id="${employee.id}">
                <i class="fas fa-key"></i>
              </button>
            </td>
          `;
          
          tableBody.appendChild(row);
        });
        
        // Add event listeners to action buttons
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            showEditEmployeeForm(id);
          });
        });
        
        document.querySelectorAll('.reset-pin-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            resetEmployeePin(id);
          });
        });
      }
      
      // Filter employees based on search and filters
      function filterEmployeesList() {
        const searchTerm = document.getElementById('search-employee').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;
        const departmentFilter = document.getElementById('department-filter').value;
        
        return employees.filter(employee => {
          // Search term filter
          const searchMatch = 
            (employee.id && employee.id.toString().includes(searchTerm)) ||
            (employee.firstName && employee.firstName.toLowerCase().includes(searchTerm)) ||
            (employee.lastName && employee.lastName.toLowerCase().includes(searchTerm)) ||
            (employee.email && employee.email.toLowerCase().includes(searchTerm));
          
          // Status filter
          const statusMatch = statusFilter === 'all' || employee.status === statusFilter;
          
          // Department filter
          const departmentMatch = departmentFilter === 'all' || employee.department === departmentFilter;
          
          return searchMatch && statusMatch && departmentMatch;
        });
      }
      
      // Filter employees (triggered by input/change events)
      function filterEmployees() {
        renderEmployeeTable();
      }
      
      // Reset filters
      function resetFilters() {
        document.getElementById('search-employee').value = '';
        document.getElementById('status-filter').value = 'all';
        document.getElementById('department-filter').value = 'all';
        renderEmployeeTable();
      }
      
      // Reset employee PIN
      function resetEmployeePin(employeeId) {
        const newPin = prompt('Enter new PIN or leave blank to generate random PIN:');
        
        if (newPin === null) {
          // User cancelled
          return;
        }
        
        showLoading();
        
        const pinData = {
          employeeId: employeeId,
          pin: newPin || Math.floor(1000 + Math.random() * 9000).toString() // Generate 4-digit PIN if empty
        };
        
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoading();
            if (result.success) {
              showAlert('success', `PIN reset successfully to: ${result.pin}`);
              loadEmployees(); // Reload to update the list
            } else {
              showAlert('danger', 'Error: ' + result.message);
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            showAlert('danger', 'Error resetting PIN: ' + error.message);
          })
          .resetEmployeePin(pinData);
      }
      
      //TIME TRACKING FUNCTIONS
      
      // Initialize date and time pickers
      function initializeDateTimePickers() {
        flatpickr(".flatpickr-date", {
          dateFormat: "Y-m-d",
          allowInput: true
        });
        
        flatpickr(".flatpickr-time", {
          enableTime: true,
          noCalendar: true,
          dateFormat: "H:i:s",
          time_24hr: true,
          allowInput: true
        });
      }
      
      // Load employees for time tracking dropdown
      function loadEmployeesForTimeTracking() {
        showLoading();
        google.script.run
          .withSuccessHandler(function(data) {
            const employeeFilter = document.getElementById('employeeFilter');
            employeeFilter.innerHTML = '<option value="">All Employees</option>';
            
            data.forEach(employee => {
              const option = document.createElement('option');
              option.value = employee.id;
              option.textContent = `${employee.firstName} ${employee.lastName}`;
              employeeFilter.appendChild(option);
            });
            hideLoading();
          })
          .withFailureHandler(handleError)
          .getEmployees(); // Use the same method as the employee section
      }
      
      // Update the loadTimeLogs function to include the missed minutes filter
function loadTimeLogs() {
  showLoading();
  const dateFilter = document.getElementById('dateFilter').value;
  const employeeFilter = document.getElementById('employeeFilter').value;
  const missedMinutesFilter = document.getElementById('missedMinutesFilter').checked;
  
  google.script.run
    .withSuccessHandler(function(timeLogs) {
      const tableBody = document.getElementById('timeLogsTableBody');
      tableBody.innerHTML = '';
      
      if (timeLogs.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="7" class="text-center">No time logs found</td>';
        tableBody.appendChild(row);
      } else {
        timeLogs.forEach(log => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${log.logId}</td>
            <td>${log.employeeName || 'ID: ' + log.employeeId}</td>
            <td>${log.date}</td>
            <td>${log.clockInTime}</td>
            <td>${log.clockOutTime}</td>
            <td class="${log.status === 'Complete' ? 'status-complete' : 'status-incomplete'}">${log.status}</td>
            <td>
              <button class="btn btn-sm btn-primary edit-time-log-btn">
                <i class="fas fa-edit"></i> Edit
              </button>
            </td>
          `;
          // Store log data as a data attribute
          row.querySelector('.edit-time-log-btn').setAttribute('data-log', JSON.stringify(log));
          tableBody.appendChild(row);
        });
        
        // Add event listeners to edit buttons
        document.querySelectorAll('.edit-time-log-btn').forEach(button => {
          button.addEventListener('click', function() {
            const logData = JSON.parse(this.getAttribute('data-log'));
            openEditModal(logData);
          });
        });
      }
      
      hideLoading();
    })
    .withFailureHandler(handleError)
    .getTimeLogs(dateFilter, employeeFilter, missedMinutesFilter);
}
      
// Open edit modal with time log data
function openEditModal(logData) {
  // Populate form fields
  document.getElementById('rowIndex').value = logData.rowIndex;
  document.getElementById('logId').value = logData.logId;
  document.getElementById('employeeId').value = logData.employeeId;
  document.getElementById('employeeName').value = logData.employeeName;
  document.getElementById('status').value = logData.status;

  // Parse the date from logData.date
  const baseDate = logData.date;

  // Set Clock In Date and Time
  if (logData.clockInTime) {
    const clockInDateTime = new Date(`${baseDate}T${logData.clockInTime}`);
    document.getElementById('clockInDate').value = baseDate;
    document.getElementById('clockInTime').value = logData.clockInTime;
  } else {
    document.getElementById('clockInDate').value = '';
    document.getElementById('clockInTime').value = '';
  }

  // Set Clock Out Date and Time
  if (logData.clockOutTime) {
    const clockOutDateTime = new Date(`${baseDate}T${logData.clockOutTime}`);
    document.getElementById('clockOutDate').value = baseDate;
    document.getElementById('clockOutTime').value = logData.clockOutTime;
  } else {
    document.getElementById('clockOutDate').value = '';
    document.getElementById('clockOutTime').value = '';
  }

  // Set break times
  document.getElementById('regularBreakStart1').value = logData.regularBreakStart1 || '';
  document.getElementById('regularBreakEnd1').value = logData.regularBreakEnd1 || '';
  document.getElementById('regularBreakStart2').value = logData.regularBreakStart2 || '';
  document.getElementById('regularBreakEnd2').value = logData.regularBreakEnd2 || '';
  document.getElementById('lunchBreakStart').value = logData.lunchBreakStart || '';
  document.getElementById('lunchBreakEnd').value = logData.lunchBreakEnd || '';

// Initialize clear buttons
initializeClearButtons();
  
  // Show modal
  editTimeLogModal.show();
}
      

// Save time log changes
function saveTimeLog() {
  showLoading();

  const rowIndex = document.getElementById('rowIndex').value;
  
  // Get date and time values
  const clockInDate = document.getElementById('clockInDate').value;
  const clockInTime = document.getElementById('clockInTime').value;
  const clockOutDate = document.getElementById('clockOutDate').value;
  const clockOutTime = document.getElementById('clockOutTime').value;
  
  // Log the form data to the console
  console.log("Form data being collected:");
  console.log("Clock In Date:", clockInDate);
  console.log("Clock In Time:", clockInTime);
  console.log("Clock Out Date:", clockOutDate || clockInDate);
  console.log("Clock Out Time:", clockOutTime);
  
  // Create the time log data object - explicitly set empty strings for cleared fields
  const timeLogData = {
    logId: document.getElementById('logId').value,
    date: clockInDate, // This is the original date field
    clockInTime: clockInTime,
    clockOutTime: clockOutTime,
    regularBreakStart1: document.getElementById('regularBreakStart1').value,
    regularBreakEnd1: document.getElementById('regularBreakEnd1').value,
    regularBreakStart2: document.getElementById('regularBreakStart2').value,
    regularBreakEnd2: document.getElementById('regularBreakEnd2').value,
    lunchBreakStart: document.getElementById('lunchBreakStart').value,
    lunchBreakEnd: document.getElementById('lunchBreakEnd').value,
    
    // Add the date fields for proper date handling
    clockInDate: clockInDate,
    clockOutDate: clockOutDate,
    
    // Add a flag to indicate fields that were explicitly cleared
    clearedFields: {
      clockInTime: clockInTime === '',
      clockOutTime: clockOutTime === '',
      clockInDate: clockInDate === '',
      clockOutDate: clockOutDate === '',
      regularBreakStart1: document.getElementById('regularBreakStart1').value === '',
      regularBreakEnd1: document.getElementById('regularBreakEnd1').value === '',
      regularBreakStart2: document.getElementById('regularBreakStart2').value === '',
      regularBreakEnd2: document.getElementById('regularBreakEnd2').value === '',
      lunchBreakStart: document.getElementById('lunchBreakStart').value === '',
      lunchBreakEnd: document.getElementById('lunchBreakEnd').value === ''
    }
  };
  
  // Log the data being sent to the server
  console.log("Time log data being sent to server:", timeLogData);

  google.script.run
    .withSuccessHandler(function(response) {
      console.log("Server response:", response);
      if (response.success) {
        editTimeLogModal.hide();
        loadTimeLogs();
        showAlert('success', 'Time log updated successfully');
      } else {
        showAlert('danger', response.message || 'Error updating time log');
        hideLoading();
      }
    })
    .withFailureHandler(function(error) {
      console.error("Server error:", error);
      handleError(error);
      hideLoading();
    })
    .updateTimeLog(rowIndex, timeLogData);
}


// Helper function to combine date and time
function combineDateTime(date, time) {
  if (!date || !time) return '';
  
  // Parse the date (assuming format YYYY-MM-DD)
  const [year, month, day] = date.split('-');
  
  // Parse the time (assuming format HH:MM or HH:MM:SS)
  const timeParts = time.split(':');
  const hours = timeParts[0];
  const minutes = timeParts[1];
  const seconds = timeParts[2] || '00';
  
  // Format directly to MM/DD/YYYY HH:MM:SS
  return `${month}/${day}/${year} ${hours}:${minutes}:${seconds}`;
}
      
      // Show alert message
      function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        const container = document.getElementById('alerts-container');
        container.appendChild(alertDiv);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
          alertDiv.classList.remove('show');
          setTimeout(() => alertDiv.remove(), 150);
        }, 5000);
      }
      
      // Handle errors
      function handleError(error) {
        console.error('Error:', error);
        hideLoading();
        showAlert('danger', 'An error occurred: ' + (error.message || error));
      }
      




      //Create new Time log functions 
      //
      //
      // Function to show the Create Time Log modal
function showCreateTimeLogModal() {
  // Set default date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('newLogClockInDate').value = today;
  document.getElementById('newLogClockOutDate').value = "";
  
  // Set default time to null
  document.getElementById('newLogClockInTime').value = "";
  
  // Populate employee dropdown
  const employeeSelect = document.getElementById('newLogEmployeeId');
  employeeSelect.innerHTML = '<option value="">Select Employee</option>';
  
  employees.forEach(emp => {
    if (emp.status === 'Active') {
      const option = document.createElement('option');
      option.value = emp.id;
      option.textContent = `${emp.firstName} ${emp.lastName} (ID: ${emp.id})`;
      employeeSelect.appendChild(option);
    }
  });
  
  // Show the modal
  createTimeLogModal.show();
}

// Function to save the new time log
function saveNewTimeLog() {
  // Validate form
  const employeeId = document.getElementById('newLogEmployeeId').value;
  const clockInDate = document.getElementById('newLogClockInDate').value;
  const clockInTime = document.getElementById('newLogClockInTime').value;
  
  if (!employeeId || !clockInDate || !clockInTime) {
    showAlert('danger', 'Please fill in all required fields.');
    return;
  }
  
  // Get form data
  const clockOutDate = document.getElementById('newLogClockOutDate').value;
  const clockOutTime = document.getElementById('newLogClockOutTime').value;
  const notes = document.getElementById('newLogNotes').value;
  
  // Format the clock-in datetime in the same format as the Time Logs sheet (MM/dd/yyyy HH:mm:ss)
  const clockInDateTime = formatDateTimeForSheet(clockInDate, clockInTime);
  
  // Format the clock-out datetime if provided
  let clockOutDateTime = '';
  if (clockOutDate && clockOutTime) {
    clockOutDateTime = formatDateTimeForSheet(clockOutDate, clockOutTime);
  }
  
  // Prepare time log data
  const timeLogData = {
    employeeId: employeeId,
    clockInDateTime: clockInDateTime,
    clockOutDateTime: clockOutDateTime,
    notes: notes
  };
  
  // Show loading spinner
  showLoading();
  
  // Call Google Apps Script function to save the time log
  google.script.run
    .withSuccessHandler(onTimeLogCreated)
    .withFailureHandler(onTimeLogCreationError)
    .createTimeLog(timeLogData);
}

// Function to format date and time for the sheet (MM/dd/yyyy HH:mm:ss)
function formatDateTimeForSheet(dateStr, timeStr) {
  const date = new Date(dateStr + 'T' + timeStr);
  
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const year = date.getFullYear();
  
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  
  return `${month}/${day}/${year} ${hours}:${minutes}:${seconds}`;
}

// Handle successful time log creation
function onTimeLogCreated(result) {
  hideLoading();
  
  if (result.success) {
    // Close the modal
    createTimeLogModal.hide();
    
    // Show success message
    showAlert('success', 'Time log created successfully!');
    
    // Reload time logs
    loadTimeLogs();
  } else {
    // Show error message
    showAlert('danger', 'Error: ' + result.message);
  }
}

// Handle time log creation error
function onTimeLogCreationError(error) {
  hideLoading();
  showAlert('danger', 'Error creating time log: ' + error.message);
}


      // Initialize dashboard when the page loads
      window.onload = function() {
  initializeDashboard();
  initOperatorAttendanceTab();
  initializeClearButtons(); 
};


















      

// Reports Tab JavaScript
$(document).ready(function() {
  // Toggle between custom date range and pay period
  $('input[name="reportType"]').change(function() {
    if ($(this).val() === 'custom') {
      $('#customDateRangeSection').show();
      $('#payPeriodSection').hide();
    } else {
      $('#customDateRangeSection').hide();
      $('#payPeriodSection').show();
    }
  });
  
  // Initialize date inputs with current date
  const today = new Date();
  const formattedDate = today.toISOString().split('T')[0];
  $('#startDate').val(formattedDate);
  
  // Load pay periods for dropdown
  loadPayPeriods();
  
  // Generate report button click handler
  $('#generateReport').click(function() {
    generateTimeReport();
  });
});

// Initialize the Reports TabA
function initReportsTab() {
  // Set default dates
  const today = new Date();
  const formattedDate = today.toISOString().split('T')[0];
  document.getElementById('startDate').value = formattedDate;
  document.getElementById('endDate').value = formattedDate;
  
  // Make sure the pay period radio is selected by default
  document.getElementById('payPeriodRange').checked = true;
  
  // Hide custom date range section and show pay period section by default
  document.getElementById('customDateRangeSection').style.display = 'none';
  document.getElementById('payPeriodSection').style.display = 'flex';
  
  // Toggle between custom date range and pay period
  document.querySelectorAll('input[name="reportType"]').forEach(input => {
    input.addEventListener('change', function() {
      if (this.value === 'custom') {
        document.getElementById('customDateRangeSection').style.display = 'flex';
        document.getElementById('payPeriodSection').style.display = 'none';
      } else {
        document.getElementById('customDateRangeSection').style.display = 'none';
        document.getElementById('payPeriodSection').style.display = 'flex';
      }
    });
  });
  
  // Generate report button click handler
  document.getElementById('generateReport').addEventListener('click', generateReport);
  
  // Export button click handlers
  document.getElementById('exportCsv').addEventListener('click', exportReportToCsv);
  document.getElementById('exportPdf').addEventListener('click', exportReportToPdf);
  
  // Add event listener for pay period change to load profit sharing info
  document.getElementById('payPeriod').addEventListener('change', loadProfitSharingInfo);
  
  // Add a "Save Profit Sharing" button
  const profitSharingContainer = document.createElement('div');
  profitSharingContainer.className = 'col-md-12 text-end mt-2';
  profitSharingContainer.innerHTML = `
    <button id="saveProfitSharing" class="btn btn-outline-primary">
      <i class="fas fa-save me-1"></i> Save Profit Sharing
    </button>
  `;
  
  const payPeriodSection = document.getElementById('payPeriodSection');
  payPeriodSection.appendChild(profitSharingContainer);
  
  // Add event listener for the Save Profit Sharing button
  document.getElementById('saveProfitSharing').addEventListener('click', handleProfitSharing);
}


// Load pay periods for dropdown
function loadPayPeriods() {
  showLoading();
  google.script.run
    .withSuccessHandler(function(payPeriods) {
      hideLoading();
      const payPeriodSelect = document.getElementById('payPeriod');
      payPeriodSelect.innerHTML = ''; // Clear existing options
      
      if (!payPeriods || payPeriods.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No pay periods found';
        payPeriodSelect.appendChild(option);
        return;
      }
      
      // Get today's date
      const today = new Date();
      let currentPeriodFound = false;
      let currentPeriodId = null;
      
      payPeriods.forEach(function(period) {
        const option = document.createElement('option');
        option.value = period.id;
        option.textContent = period.name;
        option.dataset.startDate = period.startDate;
        option.dataset.startTime = period.startTime;
        option.dataset.endDate = period.endDate;
        option.dataset.endTime = period.endTime;
        payPeriodSelect.appendChild(option);
        
        // Check if today falls within this pay period
        const startDate = new Date(period.startDate);
        const endDate = new Date(period.endDate);
        
        if (today >= startDate && today <= endDate) {
          currentPeriodFound = true;
          currentPeriodId = period.id;
        }
      });
      
      // Auto-select the current pay period if found
      if (currentPeriodFound && currentPeriodId) {
        payPeriodSelect.value = currentPeriodId;
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showAlert('danger', 'Error loading pay periods: ' + error);
    })
    .getPayPeriods();
}


function generateReport() {
  const reportLoading = document.getElementById('reportLoading');
  const reportTableBody = document.getElementById('reportTableBody');
  
  // Disable export buttons initially
  document.getElementById('exportCsv').disabled = true;
  document.getElementById('exportPdf').disabled = true;
  
  reportLoading.style.display = 'block';
  reportTableBody.innerHTML = '';
  
  let startDate, startTime, endDate, endTime, payPeriodId;
  
  // Get date range based on selection type
  if (document.getElementById('customDateRange').checked) {
    startDate = document.getElementById('startDate').value;
    startTime = document.getElementById('startTime').value || '00:00';
    endDate = document.getElementById('endDate').value;
    endTime = document.getElementById('endTime').value || '23:59';
    payPeriodId = null; // No pay period ID for custom date range
  } else {
    const selectedOption = document.getElementById('payPeriod').options[document.getElementById('payPeriod').selectedIndex];
    startDate = selectedOption.dataset.startDate;
    startTime = selectedOption.dataset.startTime || '00:00';
    endDate = selectedOption.dataset.endDate;
    endTime = selectedOption.dataset.endTime || '23:59';
    payPeriodId = selectedOption.value; // Get the pay period ID from the selected option
  }
  
  // Validate inputs
  if (!startDate || !endDate) {
    reportLoading.style.display = 'none';
    showAlert('danger', 'Please select a valid date range');
    return;
  }
  
  console.log("Generating report with:", startDate, startTime, endDate, endTime, "Pay Period ID:", payPeriodId);
  
  // First, ensure the table has the correct headers
  const headerRow = document.querySelector('#reportTable thead tr');
  if (headerRow) {
    // Update headers for the new format
    headerRow.innerHTML = `
      <th>Employee Name</th>
      <th>Employment Type</th>
      <th>Hourly Rate</th>
      <th>Regular Hours</th>
      <th>Overtime Hours</th>
      <th>Paid Break Hours</th>
      <th>Profit Sharing $</th>
    `;
  }
  
  // First, get the qualifying shifts data from the server if using a pay period
  if (payPeriodId) {
    google.script.run
      .withSuccessHandler(function(qualifyingShiftData) {
        // Once we have the qualifying shift data, get the time report
        getTimeReport(startDate, startTime, endDate, endTime, qualifyingShiftData, payPeriodId);
      })
      .withFailureHandler(function(error) {
        reportLoading.style.display = 'none';
        showAlert('danger', 'Error calculating qualifying shifts: ' + error);
      })
      .calculateEmployeeQualifyingShifts(payPeriodId);
  } else {
    // If using custom date range, just get the time report without qualifying shift data
    getTimeReport(startDate, startTime, endDate, endTime, null, null);
  }
  
  // Function to get the time report data and combine with qualifying shift data
  function getTimeReport(startDate, startTime, endDate, endTime, qualifyingShiftData, payPeriodId) {
    google.script.run
      .withSuccessHandler(function(reportData) {
        reportLoading.style.display = 'none';
        
        if (!reportData || reportData.length === 0) {
          reportTableBody.innerHTML = '<tr><td colspan="7" class="text-center">No data found for the selected date range</td></tr>';
          return;
        }
        
        // Create a map of employee IDs to qualifying shift data for quick lookup
        const qualifyingShiftMap = {};
        if (qualifyingShiftData && Array.isArray(qualifyingShiftData)) {
          qualifyingShiftData.forEach(item => {
            qualifyingShiftMap[item.employeeId] = item;
          });
        }
        
        // If we have a pay period ID, get profit sharing information
        if (payPeriodId) {
          google.script.run
            .withSuccessHandler(function(profitSharingInfo) {
              // Now populate the report with all data including profit sharing
              populateReport(reportData, qualifyingShiftMap, profitSharingInfo);
            })
            .withFailureHandler(function(error) {
              console.error("Error getting profit sharing info:", error);
              // Still populate the report, but without profit sharing data
              populateReport(reportData, qualifyingShiftMap, { success: false });
            })
            .getProfitSharingInfo(payPeriodId);
        } else {
          // No pay period ID, populate without profit sharing
          populateReport(reportData, qualifyingShiftMap, { success: false });
        }
      })
      .withFailureHandler(function(error) {
        reportLoading.style.display = 'none';
        showAlert('danger', 'Error generating report: ' + error);
      })
      .generateEmployeeTimeReport(startDate, startTime, endDate, endTime);
  }
  
  // Function to populate the report table with all data
  function populateReport(reportData, qualifyingShiftMap, profitSharingInfo) {
    reportTableBody.innerHTML = '';
    
    // Populate report table
    reportData.forEach(function(row) {
      const tr = document.createElement('tr');
      
      // Employee Name
      const nameCell = document.createElement('td');
      nameCell.textContent = row.employeeName;
      tr.appendChild(nameCell);
      
      // Employment Type
      const empTypeCell = document.createElement('td');
      empTypeCell.textContent = row.employmentType || '-';
      tr.appendChild(empTypeCell);
      
      // Hourly Rate
      const hourlyRateCell = document.createElement('td');
      if (row.hourlyRate) {
        hourlyRateCell.textContent = '$' + parseFloat(row.hourlyRate).toFixed(2);
      } else {
        hourlyRateCell.textContent = '-';
      }
      tr.appendChild(hourlyRateCell);
      
      // Calculate Regular Hours (capped at 80) and Overtime Hours
      const totalHoursWorked = parseFloat(row.totalHoursWorked);
      let regularHours = totalHoursWorked;
      let overtimeHours = 0;
      
      if (totalHoursWorked > 80) {
        regularHours = 80;
        overtimeHours = totalHoursWorked - 80;
      }
      
      // Regular Hours
      const regularHoursCell = document.createElement('td');
      regularHoursCell.textContent = regularHours.toFixed(2);
      tr.appendChild(regularHoursCell);
      
      // Overtime Hours
      const overtimeHoursCell = document.createElement('td');
      overtimeHoursCell.textContent = overtimeHours.toFixed(2);
      tr.appendChild(overtimeHoursCell);
      
      // Paid Break Hours
      const paidBreakHoursCell = document.createElement('td');
      
      // Check if employee has AUTO- logs
      if (row.hasAutoLogs === true) {
        // If employee has AUTO- logs, set paid break hours to 0
        paidBreakHoursCell.textContent = '0.00';
      } else {
        // Calculate paid break hours based on qualifying shifts
        let paidBreakHours = 0;
        if (qualifyingShiftMap[row.employeeId]) {
          const qualifyingShifts = qualifyingShiftMap[row.employeeId].qualifyingShiftsWithPaidBreaks || 0;
          paidBreakHours = qualifyingShifts * 0.5; // 30 minutes (0.5 hours) per qualifying shift
        }
        
        paidBreakHoursCell.textContent = paidBreakHours.toFixed(2);
      }
      
      tr.appendChild(paidBreakHoursCell);
      
      // Profit Sharing Amount
      const profitSharingCell = document.createElement('td');
      
      // Check if employee is eligible for profit sharing and we have valid profit sharing info
      let profitSharingAmount = 0;
      if (profitSharingInfo && profitSharingInfo.success && row.eligibleForProfitSharing === 'Yes') {
        profitSharingAmount = parseFloat(profitSharingInfo.amountPerRecipient) || 0;
        profitSharingCell.textContent = '$' + profitSharingAmount.toFixed(2);
      } else {
        profitSharingCell.textContent = '-';
      }
      
      tr.appendChild(profitSharingCell);
      reportTableBody.appendChild(tr);
    });
    
    // Enable export buttons after report is generated
    document.getElementById('exportCsv').disabled = false;
    document.getElementById('exportPdf').disabled = false;
  }
}






//
//
//
//
//
//Export Reports
// Function to generate dynamic filename based on date range
function generateReportFilename(extension) {
  let startDate, endDate;
  
  if (document.getElementById('customDateRange').checked) {
    startDate = document.getElementById('startDate').value;
    endDate = document.getElementById('endDate').value;
  } else {
    const selectedOption = document.getElementById('payPeriod').options[document.getElementById('payPeriod').selectedIndex];
    startDate = selectedOption.dataset.startDate;
    endDate = selectedOption.dataset.endDate;
  }
  
  // Format dates for filename
  startDate = startDate.replace(/-/g, '');
  endDate = endDate.replace(/-/g, '');
  
  return `Employee_Time_Report_${startDate}_to_${endDate}.${extension}`;
}

// MODIFY the exportReportToCsv function:
function exportReportToCsv() {
  const reportTableBody = document.getElementById('reportTableBody');
  const rows = reportTableBody.querySelectorAll('tr');
  
  if (rows.length === 0) {
    showAlert('warning', 'No data to export');
    return;
  }
  
  // Updated header row with correct column names
  let csvContent = "Employee Name,Employment Type,Hourly Rate,Regular Hours,Overtime Hours,Paid Break Hours,Profit Sharing $\n";
  
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length === 0) return; // Skip if no cells (like a header row)
    
    const rowData = Array.from(cells).map(cell => {
      // Escape quotes and wrap content in quotes to handle commas in data
      return `"${cell.textContent.replace(/"/g, '""')}"`;
    });
    
    csvContent += rowData.join(',') + '\n';
  });
  
  // Create a download link and trigger download
  const filename = generateReportFilename('csv');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  
  if (navigator.msSaveBlob) { // For IE
    navigator.msSaveBlob(blob, filename);
  } else {
    const url = URL.createObjectURL(blob);
    link.href = url;
    link.setAttribute('download', filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
}


// Update the exportReportToPdf function to properly use the hidden template
function exportReportToPdf() {
  // Check if we have data to export
  const reportTableBody = document.getElementById('reportTableBody');
  if (!reportTableBody || reportTableBody.querySelectorAll('tr').length === 0) {
    showAlert('warning', 'No data to export');
    return;
  }

  // Show loading indicator
  showLoading();

  try {
    // Get the template and make it visible for PDF generation
    const template = document.getElementById('reportTemplate');
    const reportDiv = template.querySelector('.pdf-report');
    
    // Get date range info
    let dateRangeText;
    if (document.getElementById('customDateRange').checked) {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      dateRangeText = `${startDate} to ${endDate}`;
    } else {
      const payPeriodSelect = document.getElementById('payPeriod');
      dateRangeText = payPeriodSelect.options[payPeriodSelect.selectedIndex].text;
    }
    
    // Set period and footer info in the template
    template.querySelector('.report-period').textContent = `Period: ${dateRangeText}`;
    template.querySelector('.report-footer').textContent = `Generated on ${new Date().toLocaleString()}`;
    
    // Copy data from the report table to the template table
    const templateTableBody = template.querySelector('tbody');
    templateTableBody.innerHTML = '';
    
    // Get data from the actual report table
    const rows = reportTableBody.querySelectorAll('tr');
    rows.forEach(row => {
      const newRow = document.createElement('tr');
      const cells = row.querySelectorAll('td');
      
      // Get the total hours worked to check for special case (80 hours)
      const totalHoursWorked = parseFloat(cells[1].textContent);
      const isExactly80Hours = Math.abs(totalHoursWorked - 80.0) <= 0.01;
      
      cells.forEach((cell, index) => {
        const newCell = document.createElement('td');
        
        // Special case: For 80-hour employees, column 4 (index 4) should be "-"
        if (index === 4 && isExactly80Hours) {
          newCell.textContent = "-";
        } else {
          newCell.textContent = cell.textContent;
        }
        
        newRow.appendChild(newCell);
      });
      
      templateTableBody.appendChild(newRow);
    });
    
    // Generate filename based on date range
    const filename = generateReportFilename('pdf');
    
    // Use html2pdf library to generate the PDF
    html2pdf()
      .set({
        margin: 10,
        filename: filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'Portrait' }
      })
      .from(reportDiv)
      .save()
      .then(() => {
        // Hide loading indicator after PDF is generated
        hideLoading();
        showAlert('success', 'PDF report has been generated');
      })
      .catch(error => {
        hideLoading();
        console.error('PDF generation error:', error);
        showAlert('danger', 'Error generating PDF: ' + error);
      });
  } catch (error) {
    hideLoading();
    console.error('Error in PDF export:', error);
    showAlert('danger', 'Error preparing PDF export: ' + error);
  }
}



/**
 * Calculates paid break hours for an employee based on their shifts
 * @param {Object} employeeData - The employee data object from the report
 * @return {number} - Total paid break hours to add
 */
function calculatePaidBreakHours(employeeData) {
  // If we don't have recordCount (representing shifts), return 0
  if (!employeeData.recordCount) return 0;
  
  // Assume each record represents a shift
  let paidBreakHours = 0;
  
  // Calculate average hours per shift
  const avgHoursPerShift = employeeData.totalHoursWorked / employeeData.recordCount;
  
  // Count how many shifts likely had > 7 hours
  // This is a simplified approach - ideally we'd have actual shift durations
  let shiftsOver7Hours = 0;
  
  if (avgHoursPerShift > 7) {
    // If avg shift is over 7 hours, assume all shifts qualify
    shiftsOver7Hours = employeeData.recordCount;
  } else {
    // Otherwise, estimate how many shifts might be over 7 hours based on total
    const totalHours = employeeData.totalHoursWorked;
    const potentialFullShifts = Math.floor(totalHours / 8); // Assuming 8-hour shifts
    const remainingHours = totalHours % 8;
    
    // Count full shifts plus any remaining time that's over 7 hours
    shiftsOver7Hours = potentialFullShifts + (remainingHours > 7 ? 1 : 0);
  }
  
  // Each qualifying shift gets 30 minutes (0.5 hours) of paid break
  paidBreakHours = shiftsOver7Hours * 0.5;
  
  return paidBreakHours;
}



//
//
//
//
//
//
//
//
//
//
//
//
//
//
//OPERATOR ATTENDANCE TAB
//
//
//
//
//
//
//
//
//
//
//
//
//
//
// Operator Attendance Tab Functions
function initOperatorAttendanceTab() {
  // Load pay periods
  google.script.run
    .withSuccessHandler(function(payPeriods) {
      const payPeriodSelect = document.getElementById('attendance-pay-period');
      payPeriodSelect.innerHTML = '';
      
      if (payPeriods && payPeriods.length > 0) {
        // Get today's date
        const today = new Date();
        let currentPeriodFound = false;
        let currentPeriodId = null;
        
        payPeriods.forEach(pp => {
          const option = document.createElement('option');
          option.value = pp.id;
          option.textContent = pp.name;
          payPeriodSelect.appendChild(option);
          
          // Check if today falls within this pay period
          const startDate = new Date(pp.startDate);
          const endDate = new Date(pp.endDate);
          
          if (today >= startDate && today <= endDate) {
            currentPeriodFound = true;
            currentPeriodId = pp.id;
          }
        });
        
        // Auto-select the current pay period if found
        if (currentPeriodFound && currentPeriodId) {
          payPeriodSelect.value = currentPeriodId;
        }
      } else {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No pay periods found';
        payPeriodSelect.appendChild(option);
      }
    })
    .withFailureHandler(function(error) {
      showAlert('danger', 'Error loading pay periods: ' + error);
    })
    .getPayPeriods();
  
  // Set up analyze button click handler
  document.getElementById('analyze-attendance').addEventListener('click', analyzeAttendance);
}

function analyzeAttendance() {
  const payPeriodId = document.getElementById('attendance-pay-period').value;
  if (!payPeriodId) {
    showAlert('Please select a pay period', 'warning');
    return;
  }
  
  // Show loading
  document.getElementById('attendance-loading').style.display = 'block';
  document.getElementById('attendance-results-container').style.display = 'none';
  document.getElementById('no-results-message').style.display = 'none';
  
  // Run analysis
  google.script.run
    .withSuccessHandler(function(results) {
      document.getElementById('attendance-loading').style.display = 'none';
      
      if (results && results.length > 0) {
        displayAttendanceResults(results);
      } else {
        document.getElementById('no-results-message').style.display = 'block';
      }
    })
    .withFailureHandler(function(error) {
      document.getElementById('attendance-loading').style.display = 'none';
      showAlert('Error analyzing attendance: ' + error, 'danger');
    })
    .analyzeOperatorAttendance(payPeriodId);
}

// Modify the displayAttendanceResults function to add the button
function displayAttendanceResults(results) {
  const resultsContainer = document.getElementById('attendance-results-container');
  const resultsBody = document.getElementById('attendance-results');
  
  resultsBody.innerHTML = '';
  
  // Count eligible employees
  let eligibleCount = 0;
  
  results.forEach(result => {
    const row = document.createElement('tr');
    
    // Determine eligibility - should meet all criteria
    const isEligible = (
      result.totalHours >= 66.5 && 
      result.shiftsWorked >= 7 && 
      result.totalMissedMinutes <= 20
    );
    
    if (isEligible) eligibleCount++;
    
    // Add row content
    row.innerHTML = `
      <td>${result.employeeId}</td>
      <td>${result.name}</td>
      <td>${result.shift}</td>
      <td>${result.totalHours.toFixed(2)}</td>
      <td>${result.shiftsWorked}</td>
      <td>${result.totalMissedMinutes.toFixed(2)}</td>
      <td><span class="badge ${isEligible ? 'bg-success' : 'bg-danger'}">${isEligible ? 'Yes' : 'No'}</span></td>
      <td><button class="btn btn-sm btn-outline-primary view-details" data-employee="${result.employeeId}">Details</button></td>
    `;
    
    resultsBody.appendChild(row);
  });
  
  // Add click handlers for details buttons
  document.querySelectorAll('.view-details').forEach(button => {
    button.addEventListener('click', function() {
      const employeeId = this.getAttribute('data-employee');
      showAttendanceDetails(employeeId, results.find(r => r.employeeId === employeeId));
    });
  });
  
  // Add the "Grant Hours" button if there are eligible employees
  const grantHoursContainer = document.getElementById('grant-hours-container') || document.createElement('div');
  grantHoursContainer.id = 'grant-hours-container';
  grantHoursContainer.className = 'mt-4 text-center';
  
  if (eligibleCount > 0) {
    grantHoursContainer.innerHTML = `
      <button id="grant-eligible-hours" class="btn btn-success btn-lg">
        <i class="fas fa-gift me-2"></i>Grant Eligible Employees 80 Hours for Selected Pay Period (${eligibleCount} eligible)
      </button>
    `;
    
    // If the container isn't already in the DOM, add it after the results container
    if (!document.getElementById('grant-hours-container')) {
      resultsContainer.parentNode.insertBefore(grantHoursContainer, resultsContainer.nextSibling);
    }
    
    // Add click handler for the grant hours button
    document.getElementById('grant-eligible-hours').addEventListener('click', grantEligibleEmployees80Hours);
  } else {
    // If there are no eligible employees, remove the button if it exists
    grantHoursContainer.innerHTML = `
      <div class="alert alert-warning">
        No eligible employees found to grant additional hours
      </div>
    `;
    
    // If the container isn't already in the DOM, add it after the results container
    if (!document.getElementById('grant-hours-container')) {
      resultsContainer.parentNode.insertBefore(grantHoursContainer, resultsContainer.nextSibling);
    }
  }
  
  resultsContainer.style.display = 'block';
}


// Function to handle the button click to grant hours
function grantEligibleEmployees80Hours() {
  const payPeriodId = document.getElementById('attendance-pay-period').value;
  if (!payPeriodId) {
    showAlert('danger', 'Please select a pay period');
    return;
  }
  
  // Show a confirmation dialog
  if (!confirm("This will create additional time log entries for eligible employees to bring their total hours to 80. Continue?")) {
    return;
  }
  
  // Show loading
  showLoading();
  
  // Call the server-side function
  google.script.run
    .withSuccessHandler(function(response) {
      hideLoading();
      
      if (response.success) {
        showAlert('success', response.message);
        
        // Show details of granted hours
        let detailsMessage = '<h5>Results:</h5><ul>';
        response.results.forEach(result => {
          if (result.success) {
            detailsMessage += `<li>${result.name}: +${result.additionalHours.toFixed(2)} hours (now 80 hours)</li>`;
          } else {
            detailsMessage += `<li>${result.name}: ${result.message}</li>`;
          }
        });
        detailsMessage += '</ul>';
        
        // Create a modal to show the details
        const detailsModal = document.createElement('div');
        detailsModal.className = 'modal fade';
        detailsModal.id = 'hoursGrantedModal';
        detailsModal.innerHTML = `
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Hours Granted Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                ${detailsMessage}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="reanalyzeAttendance">Re-analyze Attendance</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(detailsModal);
        
        const modal = new bootstrap.Modal(document.getElementById('hoursGrantedModal'));
        modal.show();
        
        // Add click handler for re-analyze button
        document.getElementById('reanalyzeAttendance').addEventListener('click', function() {
          modal.hide();
          analyzeAttendance();
        });
        
      } else {
        showAlert('danger', 'Error: ' + response.message);
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showAlert('danger', 'Error granting hours: ' + error);
    })
    .grantEligibleEmployees80Hours(payPeriodId);
}


  // This function will be called when the "Details" button is clicked
  function showAttendanceDetails(employeeId, employeeData) {
    console.log("showAttendanceDetails called with:", employeeId);
    console.log("Employee data:", employeeData);
    
    // If employeeData is not provided, we need to fetch it
    if (!employeeData) {
      console.log("No employee data provided, fetching from server...");
      // Show loading state
      document.getElementById('details-employee-name').textContent = "Loading...";
      
      // Call the server-side function to get the data
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.success) {
            // We got the data, now display it
            displayEmployeeDetails(result.data);
          } else {
            // Handle error
            console.error("Failed to fetch employee data:", result ? result.message : "Unknown error");
            alert("Failed to load employee details. Please try again.");
          }
        })
        .withFailureHandler(function(error) {
          console.error("Error fetching employee data:", error);
          alert("Error: " + error.message);
        })
        .getEmployeeAttendanceDetails(employeeId);
    } else {
      // We already have the data, display it directly
      displayEmployeeDetails(employeeData);
    }
    
    // Show the modal
    const modalElement = document.getElementById('attendanceDetailsModal');
    if (modalElement) {
      try {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      } catch (error) {
        console.error("Error showing modal:", error);
        // Fallback to manual display
        modalElement.classList.add('show');
        modalElement.style.display = 'block';
        document.body.classList.add('modal-open');
        
        // Add backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        document.body.appendChild(backdrop);
      }
    } else {
      console.error("Modal element not found");
      alert("Error: Modal element not found");
    }
  }
  
// Function to display employee details in the modal
function displayEmployeeDetails(employeeData) {
  if (!employeeData) {
    console.error("No employee data to display");
    return;
  }
  
  console.log("Displaying employee details:", employeeData);
  
  // Fill in the modal with the employee data
  document.getElementById('details-employee-name').textContent = employeeData.name || "Unknown";
  document.getElementById('details-employee-shift').textContent = `Shift: ${employeeData.shift || "Unknown"}`;
  document.getElementById('details-total-hours').textContent = employeeData.totalHours ? employeeData.totalHours.toFixed(2) : "0";
  document.getElementById('details-shifts-worked').textContent = employeeData.shiftsWorked || "0";
  document.getElementById('details-missed-minutes').textContent = employeeData.totalMissedMinutes.toFixed(2) || "0";
  
  const isEligible = (
    employeeData.totalHours >= 66.5 && 
    employeeData.shiftsWorked >= 7 && 
    employeeData.totalMissedMinutes <= 20
  );
  
  document.getElementById('details-eligibility').innerHTML = 
    `<span class="badge ${isEligible ? 'bg-success' : 'bg-danger'}">${isEligible ? 'Yes' : 'No'}</span>`;
  
  document.getElementById('details-late-minutes').textContent = employeeData.lateMinutes || "0";
  document.getElementById('details-early-minutes').textContent = employeeData.earlyMinutes || "0";
  document.getElementById('details-break-minutes').textContent = employeeData.breakMissedMinutes.toFixed(2) || "0";
  
  // Fill in the attendance log with Total Missed Minutes data
  const logContainer = document.getElementById('details-attendance-log');
  logContainer.innerHTML = '';
  
  if (employeeData.dailyLogs && employeeData.dailyLogs.length > 0) {
    console.log("Daily logs:", employeeData.dailyLogs);
    let hasLogWithMissedMinutes = false;
    
    employeeData.dailyLogs.forEach(log => {
      // Account for different property names (missedMinutes or totalMissedMinutes)
      const missedMinutes = log.totalMissedMinutes !== undefined ? log.totalMissedMinutes : 
                           (log.missedMinutes !== undefined ? log.missedMinutes : 0);
      
      // Only show logs with missed minutes greater than 0
      if (missedMinutes > 0) {
        hasLogWithMissedMinutes = true;
        const row = document.createElement('tr');
        
        row.innerHTML = `
  <td>${log.date || 'N/A'}</td>
  <td>${log.regBreak1Missed.toFixed(2) || '0'}</td>
  <td>${log.regBreak2Missed.toFixed(2) || '0'}</td>
  <td>${log.lunchBreakMissed.toFixed(2) || '0'}</td>
  <td>${log.lateArrival.toFixed(2) || '0'}</td>
  <td>${log.earlyDeparture.toFixed(2) || '0'}</td>
  <td><strong>${missedMinutes > 0 ? missedMinutes.toFixed(2) : '0'}</strong></td>
  <td>
    <button class="btn btn-sm btn-outline-primary fetch-log-details" 
            data-log-id="${log.logId || ''}"
            data-date="${log.date}" 
            data-employee-id="${employeeData.employeeId}">
      <i class="fas fa-search"></i> Details
    </button>
  </td>
`;
        logContainer.appendChild(row);
      }
    });
    
    // If no logs with missed minutes were found, show a message
    if (!hasLogWithMissedMinutes) {
      const row = document.createElement('tr');
      row.innerHTML = '<td colspan="8" class="text-center">No logs with missed minutes found</td>';
      logContainer.appendChild(row);
    }
    
// Add event listeners for details buttons
document.querySelectorAll('.fetch-log-details').forEach(button => {
  button.addEventListener('click', function() {
    const logId = this.getAttribute('data-log-id');
    const date = this.getAttribute('data-date');
    const employeeId = this.getAttribute('data-employee-id');
    
    console.log("Fetching details for log:", logId);  // For debugging
    
    // Pass the log ID to the fetch function
    fetchLogDetailsByDate(employeeId, date, logId);
  });
});
    
  } else {
    const row = document.createElement('tr');
    row.innerHTML = '<td colspan="8" class="text-center">No daily logs available</td>';
    logContainer.appendChild(row);
  }
}

// Update the fetchLogDetailsByDate function
function fetchLogDetailsByDate(employeeId, date, logId) {
  showLoading();
  
  // First, close the current Attendance Details modal
  const attendanceModal = bootstrap.Modal.getInstance(document.getElementById('attendanceDetailsModal'));
  if (attendanceModal) {
    attendanceModal.hide();
  }
  
  // If we have a logId, use it directly
  if (logId) {
    google.script.run
      .withSuccessHandler(function(logData) {
        hideLoading();
        if (logData) {
          // Add a slight delay to ensure the first modal has finished closing
          setTimeout(() => {
            openEditModal(logData);
          }, 150);
        } else {
          showAlert('warning', 'Could not find time log details');
        }
      })
      .withFailureHandler(function(error) {
        hideLoading();
        showAlert('danger', 'Error fetching time log details: ' + error);
      })
      .getTimeLogById(logId);
  } else {
    // Fall back to the old method if no logId is available
    google.script.run
      .withSuccessHandler(function(timeLogs) {
        hideLoading();
        
        if (timeLogs && timeLogs.length > 0) {
          // Find the log for this specific date
          const log = timeLogs.find(log => log.date === date);
          if (log) {
            setTimeout(() => {
              openEditModal(log);
            }, 150);
          } else {
            showAlert('warning', 'Could not find time log for the selected date');
          }
        } else {
          showAlert('warning', 'No time logs found for this employee');
        }
      })
      .withFailureHandler(function(error) {
        hideLoading();
        showAlert('danger', 'Error fetching time log details: ' + error);
      })
      .getTimeLogs(date, employeeId, false);
  }
}
  
  // Helper function to get badge class for reasons
  function getReasonsClass(reason) {
    switch(reason) {
      case 'Late Arrival':
        return 'bg-danger';
      case 'Early Departure':
        return 'bg-warning text-dark';
      case 'Extended Break':
      case 'Extended Lunch':
        return 'bg-info text-dark';
      case 'Missed Break Punch':
        return 'bg-primary';
      default:
        return 'bg-secondary';
    }
  }

// Add tab initialization
document.addEventListener('DOMContentLoaded', function() {
   // Check if Bootstrap is available
   if (typeof bootstrap === 'undefined') {
      console.error("Bootstrap JavaScript is not loaded!");
      alert("Bootstrap JavaScript is not loaded. Some features may not work correctly.");
    } else {
      console.log("Bootstrap version:", bootstrap.Modal.VERSION);
    }

  // Add the existing event listeners for the tabs
  const sidebarItems = document.querySelectorAll('.sidebar-item');
  
  sidebarItems.forEach(item => {
    item.addEventListener('click', function() {
      const tabId = this.getAttribute('data-tab');
      
      // Remove active class from all sidebar items and hide all tab content
      sidebarItems.forEach(innerItem => innerItem.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
      
      // Add active class to clicked item and show corresponding tab
      this.classList.add('active');
      
      // For the operator-attendance tab, initialize it when selected
      if (tabId === 'operator-attendance') {
        document.getElementById('operator-attendance-tab').style.display = 'block';
        initOperatorAttendanceTab();
      } else if (document.getElementById(tabId + '-tab')) {
        document.getElementById(tabId + '-tab').style.display = 'block';
      }
    });
  });
});




// Add this new function to fetch time log data for editing
function fetchTimeLogForEdit(logId, rowIndex) {
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(logData) {
      hideLoading();
      if (logData) {
        openEditModal(logData);
      } else {
        showAlert('danger', 'Could not load time log data for editing');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showAlert('danger', 'Error fetching time log: ' + error);
    })
    .getTimeLogById(logId, rowIndex);
}






//Prfit sharing functions
// Function to handle profit sharing calculations
// Function to handle profit sharing calculations
function handleProfitSharing() {
  const payPeriodId = document.getElementById('payPeriod').value;
  const profitSharingAmount = parseFloat(document.getElementById('profitSharingAmount').value) || 0;
  
  if (!payPeriodId) {
    showAlert('warning', 'Please select a pay period');
    return;
  }
  
  if (profitSharingAmount <= 0) {
    showAlert('warning', 'Please enter a valid profit sharing amount');
    return;
  }
  
  // Get the pay period name from the select element
  const payPeriodSelect = document.getElementById('payPeriod');
  const payPeriodName = payPeriodSelect.options[payPeriodSelect.selectedIndex].text;
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      
      if (result.success) {
        showAlert('success', 'Profit sharing information updated successfully');
        
        // Show details in a modal with pay period name included
        const detailsHtml = `
          <p><strong>Pay Period:</strong> ${payPeriodName}</p>
          <p><strong>Total Profit Sharing Amount:</strong> $${result.totalAmount.toFixed(2)}</p>
          <p><strong>Number of Recipients:</strong> ${result.numRecipients}</p>
          <p><strong>Amount per Recipient:</strong> $${result.amountPerRecipient.toFixed(2)}</p>
        `;
        
        showInfoModal('Profit Sharing Details', detailsHtml);
      } else {
        showAlert('danger', 'Error: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showAlert('danger', 'Error updating profit sharing: ' + error);
    })
    .updateProfitSharingInfo(payPeriodId, profitSharingAmount);
}

// Function to display an information modal
function showInfoModal(title, content) {
  // Create modal element if it doesn't exist
  let infoModal = document.getElementById('infoModal');
  
  if (!infoModal) {
    infoModal = document.createElement('div');
    infoModal.className = 'modal fade';
    infoModal.id = 'infoModal';
    infoModal.setAttribute('tabindex', '-1');
    infoModal.setAttribute('aria-hidden', 'true');
    
    infoModal.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(infoModal);
  }
  
  // Set the modal content
  infoModal.querySelector('.modal-title').textContent = title;
  infoModal.querySelector('.modal-body').innerHTML = content;
  
  // Show the modal
  const modal = new bootstrap.Modal(infoModal);
  modal.show();
}

// Load profit sharing information when a pay period is selected
function loadProfitSharingInfo() {
  const payPeriodId = document.getElementById('payPeriod').value;
  
  if (!payPeriodId) return;
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        document.getElementById('profitSharingAmount').value = result.totalAmount > 0 ? result.totalAmount : '';
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error loading profit sharing info:', error);
    })
    .getProfitSharingInfo(payPeriodId);
}


    </script>

<!-- Hidden report template for PDF export -->
<div id="reportTemplate" style="display: none;">
  <div class="pdf-report">
    <h1>Humboldt Machine Time Report</h1>
    <p class="report-period"></p>
    <table class="report-table">
      <thead>
        <tr>
          <th style="width: 20%;">Employee Name</th>
          <th style="width: 15%;">Employment Type</th>
          <th style="width: 10%;">Hourly Rate</th>
          <th style="width: 12%;">Regular Hours</th>
          <th style="width: 12%;">Overtime Hours</th>
          <th style="width: 15%;">Paid Break Hours</th>
          <th style="width: 16%;">Profit Sharing $</th>
        </tr>
      </thead>
      <tbody id="reportTableBody">
        <!-- Report data will be populated here -->
      </tbody>
    </table>
    <p class="report-footer"></p>
  </div>
</div>



    <style>
      .pdf-report {
        font-family: 'Poppins', sans-serif;
        padding: 10px;
        max-width: 800px;
        margin: 0 auto;
        background-color: #ffffff;
        border-radius: 16px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        color: #2d3748;
        line-height: 1.6;
      }
      
      .pdf-report h1 {
        color: #1e293b;
        text-align: center;
        margin-bottom: 5px;
        font-weight: 600;
      }
      
      .report-period {
        color: #475569;
        text-align: center;
        margin-top: 0;
        margin-bottom: 20px;
        font-weight: 500;
      }
      
      .report-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 0 0 1px #e2e8f0;
      }
      
      .report-table th, .report-table td {
        padding: 14px 16px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
      }
      
      .report-table th {
        background-color: #f8fafc;
        color: #1e293b;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #e2e8f0;
      }
      
      .report-table tr:nth-child(even) {
        background-color: #f1f5f9;
      }
      
      .report-table tr {
        transition: all 0.2s;
        page-break-inside: avoid; /* Prevent row from breaking across pages */
        break-inside: avoid; /* Modern browsers */
        -webkit-column-break-inside: avoid; /* Safari and older browsers */
      }
      
      .report-table tr:hover {
        background-color: #f1f5f9;
        transform: scale(1.01);
      }
      
      .report-footer {
        margin-top: 30px;
        font-size: 12px;
        color: #64748b;
        text-align: center;
        padding: 15px 0;
        border-top: 1px solid #e2e8f0;
      }
      </style>

  </body>
</html>